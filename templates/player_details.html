{% extends "base.html" %}

{% block content %}
<div class="player-details-container" id="player-report-root">
    <div class="container">
        <!-- Back Button -->
        <div class="back-button-container">
            <button onclick="goBack()" class="btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Players
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <p>Loading player details...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="alert-error" style="display:none;">
            <p><i class="fas fa-exclamation-circle"></i> <span id="error-message">Error loading player details</span></p>
        </div>

        <!-- Player Details Content -->
        <div id="player-content" style="display:none;">
            <!-- Player Header -->
            <div class="player-header">
                <div class="player-photo-container">
                    <img id="player-photo" src="https://images.pexels.com/photos/274506/pexels-photo-274506.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Player Photo" class="player-detail-photo" />
                </div>
                <div class="player-basic-info">
                    <h1 id="player-name">Player Name</h1>
                    <p id="player-team-name" class="player-team-name">Team Name</p>
                    <div class="player-meta">
                        <span class="position-badge" id="player-position">Position</span>
                        <span class="nationality-badge" id="player-nationality">Nationality</span>
                        <span class="age-badge" id="player-age">Age</span>
                        <span class="jersey-badge" id="player-jersey">Jersey</span>
                    </div>
                    <div class="player-stats-summary">
                        <div class="stat-item">
                            <span class="stat-label">Height</span>
                            <span class="stat-value" id="player-height">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Weight</span>
                            <span class="stat-value" id="player-weight">-</span>
                        </div>
                    </div>
                    <div class="player-actions">
                        <button class="btn-download-report" id="download-report-btn" style="display:none;">
                            <i class="fas fa-download"></i> Download Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Player Details Grid -->
            <div class="player-details-grid">
                <!-- Personal & Academic Information -->
                <div class="detail-section">
                    <h3><i class="fas fa-user"></i> Personal & Academic Info</h3>
                    <div class="detail-content">
                        <div class="detail-row">
                            <span class="detail-label">Player ID:</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="player-id">-</span>
                                <button class="copy-btn" id="copy-player-id" style="display: none;" title="Copy full Player ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Full Name:</span>
                            <span class="detail-value" id="player-full-name">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Birth Date:</span>
                            <span class="detail-value" id="player-birth-date">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Birth Place:</span>
                            <span class="detail-value" id="player-birth-place">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Nationality:</span>
                            <span class="detail-value" id="player-nationality-detail">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Preferred Foot:</span>
                            <span class="detail-value" id="player-foot">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Education Level:</span>
                            <span class="detail-value" id="player-education">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">School:</span>
                            <span class="detail-value" id="player-school">-</span>
                        </div>
                    </div>
                </div>

                <!-- Playing & Team Information -->
                <div class="detail-section">
                    <h3><i class="fas fa-futbol"></i> Playing & Team Info</h3>
                    <div class="detail-content">
                        <div class="detail-row">
                            <span class="detail-label">Team ID:</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="player-team-id">-</span>
                                <button class="copy-btn" id="copy-team-id" style="display: none;" title="Copy full Team ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Primary Position:</span>
                            <span class="detail-value" id="player-primary-position">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Secondary Position:</span>
                            <span class="detail-value" id="player-secondary-position">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Roles:</span>
                            <span class="detail-value" id="player-roles">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Captain:</span>
                            <span class="detail-value" id="player-captain">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Current Team:</span>
                            <span class="detail-value" id="player-team">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Current Status:</span>
                            <span class="detail-value" id="player-status">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Athletic Performance Section -->
            <div class="athletic-performance-container">
                <div class="detail-section full-width">
                    <h3><i class="fas fa-chart-line"></i> Athletic Performance</h3>
                                    <div class="detail-content" id="performance-metrics">
                    <div class="athletic-performance-grid">
                        <span style="color:#bbb;">Loading metrics...</span>
                    </div>
                </div>
                </div>
            </div>

            <!-- Biography -->
            <div class="detail-section full-width">
                <h3><i class="fas fa-book"></i> Biography</h3>
                <div class="detail-content">
                    <p id="player-biography" class="biography-text">No biography available.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Get player ID from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const playerId = urlParams.get('id');

if (playerId) {
    loadPlayerDetails(playerId);
} else {
    showError('No player ID provided');
}

function loadPlayerDetails(playerId) {
    fetch(`/players/${playerId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(player => {
            // If player has a team ID, fetch team information
            if (player.teamId) {
                return fetch(`/teams/${player.teamId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            console.warn('Could not fetch team details, using fallback');
                            return null;
                        }
                    })
                    .then(teamData => {
                        return { player, teamData };
                    })
                    .catch(error => {
                        console.warn('Error fetching team data:', error);
                        return { player, teamData: null };
                    });
            } else {
                return { player, teamData: null };
            }
        })
        .then(data => {
            displayPlayerDetails(data.player, data.teamData);
        })
        .catch(error => {
            console.error('Error loading player details:', error);
            showError('Failed to load player details: ' + error.message);
        });
}

function safeSetText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

function displayPlayerDetails(player, teamData) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('player-content').style.display = 'block';

    safeSetText('player-name', player.displayName || `${player.name || ''} ${player.lastName || ''}`.trim());
    
    // Set position badge with icon
    const positionElement = document.getElementById('player-position');
    if (positionElement) {
        positionElement.innerHTML = `<i class="fas fa-user-tag"></i> ${player.position || 'N/A'}`;
    }
    
    // Set nationality badge with icon
    const nationalityElement = document.getElementById('player-nationality');
    if (nationalityElement) {
        nationalityElement.innerHTML = `<i class="fas fa-flag"></i> ${player.nationality || 'N/A'}`;
    }

    // Set age badge with icon
    let ageText = 'N/A';
    if (player.birthDate) ageText = calculateAge(player.birthDate) + ' years';
    else if (player.age) ageText = `${player.age} years`;
    
    const ageElement = document.getElementById('player-age');
    if (ageElement) {
        ageElement.innerHTML = `<i class="fas fa-birthday-cake"></i> ${ageText}`;
    }

    // Set jersey badge with icon
    const jerseyElement = document.getElementById('player-jersey');
    if (jerseyElement) {
        if (player.jersey) {
            jerseyElement.innerHTML = `<i class="fas fa-tshirt"></i> #${player.jersey}`;
        } else {
            jerseyElement.innerHTML = `<i class="fas fa-tshirt"></i> -`;
        }
    }
    
    // Show download report button
    const downloadBtn = document.getElementById('download-report-btn');
    if (downloadBtn) {
        downloadBtn.style.display = 'inline-flex';
    }
    
    // Store player data globally for report download
    window.currentPlayerData = player;
    window.currentTeamData = teamData;
    safeSetText('player-height', player.height && player.height > 0 ? `${player.height} cm` : '-');
    safeSetText('player-weight', player.weight && player.weight > 0 ? `${player.weight} kg` : '-');
    safeSetText('player-full-name', `${player.name || ''} ${player.lastName || ''}`.trim() || 'N/A');
    safeSetText('player-birth-date', player.birthDate ? new Date(player.birthDate).toLocaleDateString() : 'N/A');
    safeSetText('player-birth-place', player.birthPlace || 'N/A');
    safeSetText('player-nationality-detail', player.nationality || 'N/A');
    safeSetText('player-foot', player.foot || 'N/A');
    safeSetText('player-education', player.education || 'N/A');
    safeSetText('player-school', player.school || 'N/A');
    
    // Format player ID to show only first 6 characters
    if (player._id) {
        const shortPlayerId = player._id.substring(0, 6) + '...';
        safeSetText('player-id', shortPlayerId);
        
        // Show copy button and set up copy functionality
        const copyPlayerBtn = document.getElementById('copy-player-id');
        copyPlayerBtn.style.display = 'inline-flex';
        copyPlayerBtn.onclick = () => copyToClipboard(player._id, 'Player ID copied to clipboard!', 'copy-player-id');
    } else {
        safeSetText('player-id', 'N/A');
    }
    safeSetText('player-primary-position', player.position || 'N/A');
    safeSetText('player-secondary-position', player.position2 || 'N/A');
    safeSetText('player-roles', player.role1 && player.role1.length > 0 ? player.role1.join(', ') : 'N/A');

    const isCaptain = (player._teamSettings || []).some(team => team.captain) || player.captain;
    safeSetText('player-captain', isCaptain ? 'Yes' : 'No');

    // Display team information
    let teamDisplayName = 'N/A';
    if (teamData && teamData.name) {
        teamDisplayName = teamData.name;
        safeSetText('player-team', teamData.name);
    } else if (player.teamId) {
        teamDisplayName = `Team ${player.teamId.slice(-4)}`;
        safeSetText('player-team', teamDisplayName);
    } else {
        safeSetText('player-team', 'N/A');
    }
    
    // Set team name in header
    const teamNameElement = document.getElementById('player-team-name');
    if (teamNameElement) {
        teamNameElement.innerHTML = `<i class="fas fa-users"></i> ${teamDisplayName}`;
    }
    
    // Format team ID to show only first 6 characters
    if (player.teamId) {
        const shortTeamId = player.teamId.substring(0, 6) + '...';
        safeSetText('player-team-id', shortTeamId);
        
        // Show copy button and set up copy functionality
        const copyBtn = document.getElementById('copy-team-id');
        copyBtn.style.display = 'inline-flex';
        copyBtn.onclick = () => copyToClipboard(player.teamId, 'Team ID copied to clipboard!');
    } else {
        safeSetText('player-team-id', 'N/A');
    }
    safeSetText('player-status', player.currentStatus || 'N/A');

    // Load enhanced athletic performance data
    loadEnhancedAthleticPerformance(playerId);

    safeSetText('player-biography', player.biography || 'No biography available.');
}



function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

function goBack() {
    window.history.back();
}

// Copy to clipboard function
function copyToClipboard(text, message, buttonId = 'copy-team-id') {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const copyBtn = document.getElementById(buttonId);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
        copyBtn.style.background = '#28a745';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.style.background = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const copyBtn = document.getElementById(buttonId);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
        copyBtn.style.background = '#28a745';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.style.background = '';
        }, 2000);
    });
}

// Función auxiliar para calcular edad desde fecha de nacimiento
function calculateAge(dateString) {
    const birth = new Date(dateString);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
}

// Load enhanced athletic performance data
function loadEnhancedAthleticPerformance(playerId) {
    fetch(`/players/${playerId}/athletic-performance`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayEnhancedAthleticPerformance(data);
        })
        .catch(error => {
            console.error('Error loading enhanced athletic performance:', error);
            // Fallback to basic display
            const perfDiv = document.getElementById('performance-metrics');
            if (perfDiv) {
                perfDiv.innerHTML = '<span style="color: var(--text-secondary);">No athletic data available.</span>';
            }
        });
}

// Display enhanced athletic performance data
function displayEnhancedAthleticPerformance(data) {
    const container = document.getElementById('performance-metrics');
    if (!container || !data.enhanced_data) {
        console.error('Athletic performance container or data not found');
        return;
    }

    let html = '<div class="athletic-performance-grid">';
    
    // Process each category and test, combining them into a single grid
    for (const [category, tests] of Object.entries(data.enhanced_data)) {
        for (const [testName, testData] of Object.entries(tests)) {
            html += displayTestWithChart(category, testName, testData);
        }
    }
    
    html += '</div>';
    container.innerHTML = html;
    
    // Initialize all charts after DOM is ready
    setTimeout(() => {
        initializeCharts(data.enhanced_data);
    }, 100);
}

function displayTestWithChart(category, testName, testData) {
    const unit = testData.unit || '';
    const measurements = testData.measurements || [];
    const positionAgeMedian = testData.position_age_median;
    const teamMedian = testData.team_median;
    
    // Create unique chart ID
    const chartId = `chart-${testName.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}`;
    
    let html = `<div class="test-section">`;
    html += `<h5 class="test-title">${category} - ${testName}</h5>`;
    
    // Chart container
    html += `<div class="chart-container">`;
    html += `<canvas id="${chartId}" width="400" height="200"></canvas>`;
    html += `</div>`;
    
    // Store data for chart initialization
    if (!window.chartData) window.chartData = {};
    window.chartData[chartId] = {
        testName,
        measurements,
        positionAgeMedian,
        teamMedian,
        unit
    };
    
    html += `</div>`;
    return html;
}

// Initialize all charts
function initializeCharts(enhancedData) {
    if (!window.chartData) return;
    
    Object.keys(window.chartData).forEach(chartId => {
        const data = window.chartData[chartId];
        const canvas = document.getElementById(chartId);
        if (!canvas) return;
        
        createChart(canvas, data);
    });
}

// Create individual chart
function createChart(canvas, data) {
    const ctx = canvas.getContext('2d');
    
                    // Prepare data for chart - single line with different point colors
                const labels = [];
                const allData = [];
                const pointColors = [];
                // Validar y limpiar datos antes de crear el gráfico
                if (data.measurements) {
                    data.measurements = data.measurements.map(measurement => {
                        if (typeof measurement.value === 'number' && 
                            (isNaN(measurement.value) || !isFinite(measurement.value))) {
                            measurement.value = 0;
                        }
                        return measurement;
                    });
                }
                
                data.measurements.forEach((measurement, index) => {
                    const date = new Date(measurement.date);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    labels.push(formattedDate);
                    allData.push(measurement.value);
                    
                    // Set point color based on data type
                    if (measurement.is_real) {
                        pointColors.push('#4CAF50'); // Green for real data
                    } else {
                        pointColors.push('#FF9800'); // Orange for generated data
                    }
                });
                
                // Create single dataset with dynamic point colors
                const datasets = [
                    {
                        label: 'Measurements',
                        data: allData,
                        borderColor: '#4CAF50',
                        backgroundColor: '#4CAF50',
                        pointBackgroundColor: pointColors,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.1,
                        fill: false
                    }
                ];
    
    // Add median lines if available
    if (data.positionAgeMedian !== null && data.positionAgeMedian !== undefined) {
        datasets.push({
            label: 'Position & Age Median',
            data: Array(labels.length).fill(data.positionAgeMedian),
            borderColor: '#2196F3',
            backgroundColor: '#2196F3',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
            type: 'line'
        });
    }
    
    if (data.teamMedian !== null && data.teamMedian !== undefined) {
        datasets.push({
            label: 'Team Median',
            data: Array(labels.length).fill(data.teamMedian),
            borderColor: '#9C27B0',
            backgroundColor: '#9C27B0',
            borderWidth: 2,
            borderDash: [3, 3],
            pointRadius: 0,
            fill: false,
            type: 'line'
        });
    }
    
    // Chart configuration
    const config = {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#333333',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                                                            label: function(context) {
                                        const value = context.parsed.y;
                                        if (value === null) return null;
                                        
                                        let formattedValue = value;
                                        if (typeof value === 'number' && !Number.isInteger(value)) {
                                            formattedValue = value.toFixed(2);
                                        }
                                        
                                        const unit = data.unit || '';
                                        const datasetIndex = context.datasetIndex;
                                        const datasets = context.chart.data.datasets;
                                        const dataset = datasets[datasetIndex];
                                        
                                        // Check if this is a median line dataset
                                        if (dataset.label && dataset.label.includes('Median')) {
                                            if (dataset.label.includes('Position/Age')) {
                                                return `Position/Age Median: ${formattedValue}${unit} - Average performance for players in same position (±3 years age range)`;
                                            } else if (dataset.label.includes('Team')) {
                                                return `Team Median: ${formattedValue}${unit} - Average performance for all players in current team`;
                                            } else {
                                                return `${dataset.label}: ${formattedValue}${unit}`;
                                            }
                                        }
                                        
                                        // For measurement data points
                                        const pointIndex = context.dataIndex;
                                        const measurement = data.measurements[pointIndex];
                                        
                                        // Determine data type based on the measurement
                                        const dataType = measurement.is_real ? 'Real' : 'Generated';
                                        return `Measurement: ${formattedValue}${unit} (${dataType})`;
                                    }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: false
                    },
                    ticks: {
                        color: '#ffffff',
                        maxRotation: 45
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: false
                    },
                    ticks: {
                        color: '#ffffff',
                        callback: function(value) {
                            if (typeof value === 'number' && !Number.isInteger(value)) {
                                return value.toFixed(2);
                            }
                            return value;
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    };
    
    // Create the chart and ensure it's registered properly
    const chart = new Chart(ctx, config);
    
    // Store reference for PDF generation (opcional)
    if (!window.__charts) window.__charts = [];
    window.__charts.push(chart);
    
    return chart;
}

// Download player report function
function downloadPlayerReport() {
    if (!playerId) {
        console.error('No player ID available for report');
        return;
    }
    
    // Open report in new tab for printing/saving as PDF
    const reportUrl = `/player-report/${playerId}`;
    //window.open(reportUrl, '_blank');
}
</script>
{% endblock %}
