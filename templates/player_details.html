{% extends "base.html" %}

{% block content %}
<div class="player-details-container">
    <div class="container">
        <!-- Back Button -->
        <div class="back-button-container">
            <button onclick="goBack()" class="btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Players
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading-container">
            <div class="spinner"></div>
            <p>Loading player details...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="alert-error" style="display:none;">
            <p><i class="fas fa-exclamation-circle"></i> <span id="error-message">Error loading player details</span></p>
        </div>

        <!-- Player Details Content -->
        <div id="player-content" style="display:none;">
            <!-- Player Header -->
            <div class="player-header">
                <div class="player-photo-container">
                    <img id="player-photo" src="https://images.pexels.com/photos/274506/pexels-photo-274506.jpeg?auto=compress&cs=tinysrgb&w=400" alt="Player Photo" class="player-detail-photo" />
                </div>
                <div class="player-basic-info">
                    <h1 id="player-name">Player Name</h1>
                    <p id="player-team-name" class="player-team-name">Team Name</p>
                    <div class="player-meta">
                        <span class="position-badge" id="player-position">Position</span>
                        <span class="nationality-badge" id="player-nationality">Nationality</span>
                        <span class="age-badge" id="player-age">Age</span>
                        <span class="jersey-badge" id="player-jersey">Jersey</span>
                    </div>
                    <div class="player-stats-summary">
                        <div class="stat-item">
                            <span class="stat-label">Height</span>
                            <span class="stat-value" id="player-height">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Weight</span>
                            <span class="stat-value" id="player-weight">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Player Details Grid -->
            <div class="player-details-grid">
                <!-- Personal & Academic Information -->
                <div class="detail-section">
                    <h3><i class="fas fa-user"></i> Personal & Academic Info</h3>
                    <div class="detail-content">
                        <div class="detail-row">
                            <span class="detail-label">Player ID:</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="player-id">-</span>
                                <button class="copy-btn" id="copy-player-id" style="display: none;" title="Copy full Player ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Full Name:</span>
                            <span class="detail-value" id="player-full-name">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Birth Date:</span>
                            <span class="detail-value" id="player-birth-date">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Birth Place:</span>
                            <span class="detail-value" id="player-birth-place">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Nationality:</span>
                            <span class="detail-value" id="player-nationality-detail">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Preferred Foot:</span>
                            <span class="detail-value" id="player-foot">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Education Level:</span>
                            <span class="detail-value" id="player-education">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">School:</span>
                            <span class="detail-value" id="player-school">-</span>
                        </div>
                    </div>
                </div>

                <!-- Playing & Team Information -->
                <div class="detail-section">
                    <h3><i class="fas fa-futbol"></i> Playing & Team Info</h3>
                    <div class="detail-content">
                        <div class="detail-row">
                            <span class="detail-label">Team ID:</span>
                            <div class="detail-value-container">
                                <span class="detail-value" id="player-team-id">-</span>
                                <button class="copy-btn" id="copy-team-id" style="display: none;" title="Copy full Team ID">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Primary Position:</span>
                            <span class="detail-value" id="player-primary-position">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Secondary Position:</span>
                            <span class="detail-value" id="player-secondary-position">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Roles:</span>
                            <span class="detail-value" id="player-roles">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Captain:</span>
                            <span class="detail-value" id="player-captain">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Current Team:</span>
                            <span class="detail-value" id="player-team">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Current Status:</span>
                            <span class="detail-value" id="player-status">-</span>
                        </div>
                    </div>
                </div>

                <!-- Athletic Performance Metrics -->
                <div class="detail-section">
                    <h3><i class="fas fa-chart-line"></i> Athletic Performance</h3>
                    <div class="detail-content" id="performance-metrics">
                        <span style="color:#bbb;">Loading metrics...</span>
                    </div>
                </div>
            </div>

            <!-- Biography -->
            <div class="detail-section full-width">
                <h3><i class="fas fa-book"></i> Biography</h3>
                <div class="detail-content">
                    <p id="player-biography" class="biography-text">No biography available.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Get player ID from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const playerId = urlParams.get('id');

if (playerId) {
    loadPlayerDetails(playerId);
} else {
    showError('No player ID provided');
}

function loadPlayerDetails(playerId) {
    fetch(`/players/${playerId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(player => {
            // If player has a team ID, fetch team information
            if (player.teamId) {
                return fetch(`/teams/${player.teamId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            console.warn('Could not fetch team details, using fallback');
                            return null;
                        }
                    })
                    .then(teamData => {
                        return { player, teamData };
                    })
                    .catch(error => {
                        console.warn('Error fetching team data:', error);
                        return { player, teamData: null };
                    });
            } else {
                return { player, teamData: null };
            }
        })
        .then(data => {
            displayPlayerDetails(data.player, data.teamData);
        })
        .catch(error => {
            console.error('Error loading player details:', error);
            showError('Failed to load player details: ' + error.message);
        });
}

function safeSetText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

function displayPlayerDetails(player, teamData) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('player-content').style.display = 'block';

    safeSetText('player-name', player.displayName || `${player.name || ''} ${player.lastName || ''}`.trim());
    
    // Set position badge with icon
    const positionElement = document.getElementById('player-position');
    if (positionElement) {
        positionElement.innerHTML = `<i class="fas fa-user-tag"></i> ${player.position || 'N/A'}`;
    }
    
    // Set nationality badge with icon
    const nationalityElement = document.getElementById('player-nationality');
    if (nationalityElement) {
        nationalityElement.innerHTML = `<i class="fas fa-flag"></i> ${player.nationality || 'N/A'}`;
    }

    // Set age badge with icon
    let ageText = 'N/A';
    if (player.birthDate) ageText = calculateAge(player.birthDate) + ' years';
    else if (player.age) ageText = `${player.age} years`;
    
    const ageElement = document.getElementById('player-age');
    if (ageElement) {
        ageElement.innerHTML = `<i class="fas fa-birthday-cake"></i> ${ageText}`;
    }

    // Set jersey badge with icon
    const jerseyElement = document.getElementById('player-jersey');
    if (jerseyElement) {
        if (player.jersey) {
            jerseyElement.innerHTML = `<i class="fas fa-tshirt"></i> #${player.jersey}`;
        } else {
            jerseyElement.innerHTML = `<i class="fas fa-tshirt"></i> -`;
        }
    }
    safeSetText('player-height', player.height && player.height > 0 ? `${player.height} cm` : '-');
    safeSetText('player-weight', player.weight && player.weight > 0 ? `${player.weight} kg` : '-');
    safeSetText('player-full-name', `${player.name || ''} ${player.lastName || ''}`.trim() || 'N/A');
    safeSetText('player-birth-date', player.birthDate ? new Date(player.birthDate).toLocaleDateString() : 'N/A');
    safeSetText('player-birth-place', player.birthPlace || 'N/A');
    safeSetText('player-nationality-detail', player.nationality || 'N/A');
    safeSetText('player-foot', player.foot || 'N/A');
    safeSetText('player-education', player.education || 'N/A');
    safeSetText('player-school', player.school || 'N/A');
    
    // Format player ID to show only first 6 characters
    if (player._id) {
        const shortPlayerId = player._id.substring(0, 6) + '...';
        safeSetText('player-id', shortPlayerId);
        
        // Show copy button and set up copy functionality
        const copyPlayerBtn = document.getElementById('copy-player-id');
        copyPlayerBtn.style.display = 'inline-flex';
        copyPlayerBtn.onclick = () => copyToClipboard(player._id, 'Player ID copied to clipboard!', 'copy-player-id');
    } else {
        safeSetText('player-id', 'N/A');
    }
    safeSetText('player-primary-position', player.position || 'N/A');
    safeSetText('player-secondary-position', player.position2 || 'N/A');
    safeSetText('player-roles', player.role1 && player.role1.length > 0 ? player.role1.join(', ') : 'N/A');

    const isCaptain = (player._teamSettings || []).some(team => team.captain) || player.captain;
    safeSetText('player-captain', isCaptain ? 'Yes' : 'No');

    // Display team information
    let teamDisplayName = 'N/A';
    if (teamData && teamData.name) {
        teamDisplayName = teamData.name;
        safeSetText('player-team', teamData.name);
    } else if (player.teamId) {
        teamDisplayName = `Team ${player.teamId.slice(-4)}`;
        safeSetText('player-team', teamDisplayName);
    } else {
        safeSetText('player-team', 'N/A');
    }
    
    // Set team name in header
    const teamNameElement = document.getElementById('player-team-name');
    if (teamNameElement) {
        teamNameElement.innerHTML = `<i class="fas fa-users"></i> ${teamDisplayName}`;
    }
    
    // Format team ID to show only first 6 characters
    if (player.teamId) {
        const shortTeamId = player.teamId.substring(0, 6) + '...';
        safeSetText('player-team-id', shortTeamId);
        
        // Show copy button and set up copy functionality
        const copyBtn = document.getElementById('copy-team-id');
        copyBtn.style.display = 'inline-flex';
        copyBtn.onclick = () => copyToClipboard(player.teamId, 'Team ID copied to clipboard!');
    } else {
        safeSetText('player-team-id', 'N/A');
    }
    safeSetText('player-status', player.currentStatus || 'N/A');

    // Load enhanced athletic performance data
    loadEnhancedAthleticPerformance(playerId);

    safeSetText('player-biography', player.biography || 'No biography available.');
}



function showError(message) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

function goBack() {
    window.history.back();
}

// Copy to clipboard function
function copyToClipboard(text, message, buttonId = 'copy-team-id') {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const copyBtn = document.getElementById(buttonId);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
        copyBtn.style.background = '#28a745';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.style.background = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const copyBtn = document.getElementById(buttonId);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
        copyBtn.style.background = '#28a745';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.style.background = '';
        }, 2000);
    });
}

// Función auxiliar para calcular edad desde fecha de nacimiento
function calculateAge(dateString) {
    const birth = new Date(dateString);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
}

// Load enhanced athletic performance data
function loadEnhancedAthleticPerformance(playerId) {
    fetch(`/players/${playerId}/athletic-performance`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayEnhancedAthleticPerformance(data);
        })
        .catch(error => {
            console.error('Error loading enhanced athletic performance:', error);
            // Fallback to basic display
            const perfDiv = document.getElementById('performance-metrics');
            if (perfDiv) {
                perfDiv.innerHTML = '<span style="color: var(--text-secondary);">No athletic data available.</span>';
            }
        });
}

// Display enhanced athletic performance data
function displayEnhancedAthleticPerformance(data) {
    const container = document.getElementById('performance-metrics');
    if (!container || !data.enhanced_data) {
        console.error('Athletic performance container or data not found');
        return;
    }

    let html = '<div class="athletic-performance-section">';
    html += '<h3><i class="fas fa-chart-line"></i> Enhanced Athletic Performance</h3>';
    
    // Process each category
    for (const [category, tests] of Object.entries(data.enhanced_data)) {
        html += `<div class="category-section">`;
        html += `<h4 class="category-title">${category}</h4>`;
        
        for (const [testName, testData] of Object.entries(tests)) {
            html += displayTestWithHistory(testName, testData);
        }
        
        html += `</div>`;
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function displayTestWithHistory(testName, testData) {
    const unit = testData.unit || '';
    const measurements = testData.measurements || [];
    const positionAgeMedian = testData.position_age_median;
    const teamMedian = testData.team_median;
    
    let html = `<div class="test-section">`;
    html += `<h5 class="test-title">${testName}</h5>`;
    
    // Display historical measurements
    if (measurements.length > 0) {
        html += `<div class="measurements-list">`;
        html += `<div class="measurements-header">`;
        html += `<span class="measurement-date">Date</span>`;
        html += `<span class="measurement-value">Value</span>`;
        html += `<span class="measurement-type">Type</span>`;
        html += `</div>`;
        
        for (const measurement of measurements) {
            const isReal = measurement.is_real;
            const symbol = isReal ? '●' : '○';
            const symbolClass = isReal ? 'real-data' : 'generated-data';
            const tooltip = isReal ? 'Real measurement' : 'Generated data';
            
            html += `<div class="measurement-row">`;
            html += `<span class="measurement-date">${measurement.date}</span>`;
            // Format value to show only 2 decimal points for non-integer data
            let formattedValue = measurement.value;
            if (typeof measurement.value === 'number' && !Number.isInteger(measurement.value)) {
                formattedValue = measurement.value.toFixed(2);
            }
            html += `<span class="measurement-value">${formattedValue}${unit}</span>`;
            html += `<span class="measurement-type ${symbolClass}" title="${tooltip}">${symbol}</span>`;
            html += `</div>`;
        }
        html += `</div>`;
    }
    
    // Display median comparisons
    html += `<div class="median-comparisons">`;
    html += `<h6 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 0.9rem; width: 100%;">📊 Comparative Analysis</h6>`;
    if (positionAgeMedian !== null && positionAgeMedian !== undefined) {
        // Format median to show only 2 decimal points for non-integer data
        let formattedPositionMedian = positionAgeMedian;
        if (typeof positionAgeMedian === 'number' && !Number.isInteger(positionAgeMedian)) {
            formattedPositionMedian = positionAgeMedian.toFixed(2);
        }
        html += `<div class="median-box position-age-median">`;
        html += `<span class="median-label">Position & Age Median (±3):</span>`;
        html += `<span class="median-value">${formattedPositionMedian}${unit}</span>`;
        html += `</div>`;
    }
    if (teamMedian !== null && teamMedian !== undefined) {
        // Format median to show only 2 decimal points for non-integer data
        let formattedTeamMedian = teamMedian;
        if (typeof teamMedian === 'number' && !Number.isInteger(teamMedian)) {
            formattedTeamMedian = teamMedian.toFixed(2);
        }
        html += `<div class="median-box team-median">`;
        html += `<span class="median-label">Team Median:</span>`;
        html += `<span class="median-value">${formattedTeamMedian}${unit}</span>`;
        html += `</div>`;
    }
    html += `</div>`;
    
    html += `</div>`;
    return html;
}
</script>
{% endblock %}
